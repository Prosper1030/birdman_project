# 依賴關係編輯器

我了解您想要改進 yEd 風格編輯器中連線與節點邊緣接觸點的精確度問題。這是圖形編輯器中的一個經典挑戰。

基於您的程式碼分析，我發現主要問題在於 `getConnectionPoint` 方法的計算邏輯。讓我提供一個完整的改進方案：現在讓我提供完整的改進方案說明：

## 核心改進點

### 1\. **精確交點計算算法**

改進的 `getExactIntersectionPoint` 方法使用了線段相交檢測算法：

- 使用 Qt 的 `QLineF.intersects()` 方法精確計算連線與矩形四條邊的交點

- 驗證交點確實在邊緣上（考慮浮點誤差）

- 智能選擇最合適的交點（源節點選擇離目標最近的，目標節點選擇離源最近的）

### 2\. **改進的備用算法**

當精確交點計算失敗時，`getFallbackConnectionPoint` 使用參數化射線-矩形相交算法：

- 計算射線進入和離開矩形的參數 t

- 根據方向選擇正確的交點

- 確保結果點確實在矩形邊界上

### 3\. **箭頭精確定位**

- `calculateArrowAdjustedEndpoint` 方法微調連線終點，防止箭頭穿透節點

- 箭頭尖端精確指向節點邊緣

- 可調整的 `arrowBackOffset` 參數控制視覺效果

### 4\. **關鍵參數調整**\## yEd 的連線處理原理

---

yEd 使用了幾個關鍵技術來實現精確的連線：

### 1\. **多錨點系統**

- 每個節點有多個預定義的連線錨點（通常是8個：4個角點 + 4個邊中點）

- 連線會自動選擇最優的錨點

### 2\. **動態交點計算**

- 使用射線-矩形相交算法動態計算精確交點

- 考慮節點的實際形狀（矩形、圓角矩形、橢圓等）

### 3\. **路徑優化**

- 自動路由避免穿過其他節點

- 正交路由選項（Manhattan routing）

---

## 整合到您的專案

要將這些改進整合到您的 `dsm_`[`editor.py`](editor.py) 中，請按以下步驟：

讓我繼續完成整合指南：現在讓我提供最終的實施建議和注意事項：## 實施步驟總結

### 1\. **直接替換 EdgeItem 類**

將 `dsm_`[`editor.py`](editor.py) 中的 `EdgeItem` 類替換為上面提供的 `PrecisionEdgeItem` 類（或直接更新現有的 EdgeItem 類方法）。

### 2\. **關鍵改進點**

- **精確交點計算**：使用 `QLineF.intersects()` 方法精確計算交點

- **浮點誤差處理**：設定 `PRECISION_TOLERANCE` 常數處理浮點運算誤差

- **箭頭精確定位**：箭頭尖端精確指向節點邊緣，並有微小後退避免穿透

- **效能優化**：快取計算結果，避免重複計算

### 3\. **測試要點**

測試不同場景下的連線精確度：

- 水平/垂直連線

- 對角線連線

- 極短距離連線

- 節點大小變化

- 節點快速移動

### 4\. **可選的進階功能**

如果需要更進階的功能，可以考慮：

- 支援圓角矩形節點

- 支援橢圓形節點

- 正交路由（Manhattan routing）

- 自動避障路由

## 原理說明

yEd 和其他專業圖形編輯器通常使用以下技術：

1. **射線投射算法**：從一個節點中心向另一個節點發射射線，計算與邊界的交點

2. **參數化線段相交**：使用參數方程精確計算線段交點

3. **錨點系統**：預定義的連線點，提供可預測的連線行為

4. **智能路由**：根據節點位置關係選擇最佳路徑

這個改進方案結合了這些技術，確保連線始終精確接觸節點邊緣，提供專業級的視覺效果。