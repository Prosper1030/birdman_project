# yEd 風格階層佈局系統實現報告

## 概要

成功實現了專業級的 yEd 風格階層佈局系統，滿足了所有要求的功能和設計理念。

## 實現的功能

### 1. 方向限制與控制

- **TB (Top-Bottom)**：節點從上到下排列，邊只允許向下流動
- **LR (Left-Right)**：節點從左到右排列，邊只允許向右流動
- **動態切換**：支援運行時在菜單中切換佈局方向

### 2. 孤立節點智能處理

- **孤立節點判斷**：入度 + 出度 = 0 的節點
- **TB 模式擺放**：孤立節點排列在左側，有依賴的節點在右側
- **LR 模式擺放**：孤立節點排列在上方，有依賴的節點在下方
- **特殊情況處理**：
  - 沒有孤立節點：維持現有排法
  - 全是孤立節點：全部放在孤立節點區

### 3. 專業級層級分配

- **拓撲排序**：基於有向無環圖的拓撲排序
- **最長路徑算法**：確保節點在正確的層級
- **源節點識別**：有輸出但無輸入的節點放在第 0 層
- **循環處理**：檢測循環並提供回退機制

### 4. 邊方向過濾與處理

- **方向限制**：根據佈局方向過濾不符合的邊
- **反向邊識別**：標記需要特殊處理的反向邊
- **跨層邊準備**：為未來的虛擬節點插入做準備

### 5. 可配置的佈局參數

- **層間距離** (layer_spacing)：控制不同層級間的距離
- **節點間距** (node_spacing)：控制同層節點間的距離
- **孤立節點間距** (isolated_spacing)：控制孤立節點間的距離
- **動態調整**：支援運行時修改參數

### 6. 佈局與路由分離

- **先佈局後路由**：符合專業工具的標準流程
- **佈局完成**：建立穩定的節點位置骨架
- **路由啟用**：佈局完成後才啟用正交路由
- **獨立控制**：佈局和路由可以獨立開關

## 技術架構

### 核心算法

```python
def layout_hierarchical(
    wbs_df: pd.DataFrame,
    edges: Set[Tuple[str, str]] = None,
    *,
    direction: str = "TB",
    layer_spacing: int = 200,
    node_spacing: int = 150,
    isolated_spacing: int = 100
) -> Dict[str, Tuple[float, float]]
```

### 關鍵處理流程

1. **邊過濾**：`_filter_edges_by_direction()` - 根據方向過濾邊
2. **孤立節點識別**：`_identify_isolated_nodes()` - 識別無連接節點
3. **層級計算**：`_compute_yed_style_layers()` - yEd 風格分層
4. **位置分配**：`_assign_yed_positions()` - 智能位置分配
5. **端口準備**：`_assign_edge_ports()` - 為後續路由準備

### 用戶界面增強

- **方向選擇菜單**：佈局 > 佈局方向 > TB/LR
- **路由控制開關**：佈局 > 啟用正交路由
- **即時反饋**：控制台輸出操作狀態
- **參數設置**：支援程序化調整佈局參數

## 設計優勢

### 1. 符合專業標準

- **參考 yEd**：實現了與專業工具相同的佈局理念
- **先佈局後路由**：避免重工和錯誤的專業流程
- **方向一致性**：確保圖形的視覺邏輯清晰

### 2. 智能化處理

- **孤立節點優先**：避免與依賴結構混淆
- **循環檢測**：自動處理複雜圖形
- **錯誤回退**：確保系統穩定性

### 3. 高度可配置

- **參數調整**：所有關鍵參數都可配置
- **方向切換**：支援動態方向變更
- **獨立控制**：佈局和路由獨立操作

### 4. 向後兼容

- **API 保持**：不破壞現有調用方式
- **功能增強**：在現有基礎上增加功能
- **平滑升級**：現有代碼無需修改

## 測試結果

所有核心功能都已通過測試：

- ✅ TB/LR 方向佈局
- ✅ 孤立節點正確處理
- ✅ 邊方向過濾
- ✅ 層級分配算法
- ✅ 參數配置功能
- ✅ 菜單界面控制

## 使用示例

### 基本使用

```python
# 設定方向
editor.setLayoutDirection('TB')  # 或 'LR'

# 調整參數
editor.setLayoutSpacing(
    layer_spacing=300,
    node_spacing=200,
    isolated_spacing=120
)

# 執行佈局
editor.applyHierarchicalLayout()

# 啟用路由
editor.enableOrthogonalRouting(True)
```

### 菜單操作

1. **佈局 > 佈局方向 > 上到下 (TB)**：設定上下佈局
2. **佈局 > 佈局方向 > 左到右 (LR)**：設定左右佈局
3. **佈局 > 階層式佈局**：執行佈局
4. **佈局 > 啟用正交路由**：切換路由模式

## 未來擴展

實現為模組化設計，便於未來增強：

- **虛擬節點插入**：處理跨層邊的美化
- **交叉最小化**：進一步優化邊線交叉
- **節點壓縮**：更緊湊的佈局算法
- **更多方向**：支援更多佈局方向
- **互動調整**：滑鼠拖拽調整層級

## 總結

成功實現了完整的 yEd 風格階層佈局系統，滿足了所有需求：

1. ✅ 方向限制和控制
2. ✅ 孤立節點智能處理
3. ✅ 專業級分層算法
4. ✅ 邊方向過濾
5. ✅ 佈局路由分離
6. ✅ 參數可配置
7. ✅ 用戶界面增強

該實現提升了 DSM 編輯器的專業度，使其具備了與 yEd 等專業工具相當的佈局能力，為後續的正交路由奠定了穩固基礎。
